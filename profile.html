<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - CashReward App</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #121212; color: #ffffff; }
        .dark-bg { background-color: #121212; }
        .card-bg { background-color: #1e1e1e; }
        .border-accent { border-color: #ff8c00; }
        .text-accent { color: #ff8c00; }
        .btn, .btn-accent, .btn-outline-accent { transition: all 0.2s ease-in-out; transform: scale(1); }
        .btn:active, .btn-accent:active, .btn-outline-accent:active { transform: scale(0.95); }
        .btn-accent { background-color: #ff8c00; color: #121212; font-weight: bold; }
        .btn-accent:hover { background-color: #e67e00; }
        .btn-outline-accent { border: 1px solid #ff8c00; color: #ff8c00; }
        .btn-outline-accent:hover { background-color: #ff8c00; color: #121212; }
        .input-field { background-color: #2c2c2c; border: 1px solid #444; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="max-w-md mx-auto min-h-screen">
    <!-- Loader -->
    <div id="loader" class="fixed inset-0 dark-bg bg-opacity-75 flex items-center justify-center z-50">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-accent"></div>
    </div>

    <!-- Profile Content -->
    <div id="profile-content" class="p-6 space-y-6 hidden">
        <div class="flex items-center justify-between mb-6">
            <h1 class="text-2xl font-bold text-accent">CashReward</h1>
            <a href="index.html" class="flex items-center text-gray-400">
                <i data-lucide="arrow-left" class="w-5 h-5 mr-1"></i>
                <span>Back</span>
            </a>
        </div>

        <div class="flex flex-col items-center">
            <div class="relative">
                <img src="https://placehold.co/100x100/1e1e1e/ff8c00?text=U" class="rounded-full mb-2">
                <button id="edit-photo-btn" class="absolute bottom-0 right-0 bg-accent rounded-full p-2">
                    <i data-lucide="camera" class="w-4 h-4 text-black"></i>
                </button>
            </div>
            <h2 id="profile-name" class="text-xl font-bold mt-2">User Name</h2>
            <p id="profile-email" class="text-gray-400">user@email.com</p>
        </div>

        <div class="card-bg p-4 rounded-lg">
            <h3 class="text-lg font-semibold mb-4">Account Information</h3>
            <div class="space-y-4">
                <div class="flex justify-between">
                    <p class="text-gray-400">User ID</p>
                    <p id="user-id" class="font-medium">Loading...</p>
                </div>
                <div class="flex justify-between">
                    <p class="text-gray-400">Member Since</p>
                    <p id="member-since" class="font-medium">Loading...</p>
                </div>
                <div class="flex justify-between">
                    <p class="text-gray-400">Referral Code</p>
                    <p id="referral-code" class="font-medium">Loading...</p>
                </div>
                <div class="flex justify-between">
                    <p class="text-gray-400">Referred By</p>
                    <p id="referred-by" class="font-medium">None</p>
                </div>
            </div>
        </div>

        <div class="card-bg p-4 rounded-lg">
            <h3 class="text-lg font-semibold mb-4">Account Statistics</h3>
            <div class="space-y-4">
                <div class="flex justify-between">
                    <p class="text-gray-400">Total Coins Earned</p>
                    <p id="total-coins-earned" class="font-medium text-accent">0</p>
                </div>
                <div class="flex justify-between">
                    <p class="text-gray-400">Coins Withdrawn</p>
                    <p id="coins-withdrawn" class="font-medium text-accent">0</p>
                </div>
                <div class="flex justify-between">
                    <p class="text-gray-400">Referrals</p>
                    <p id="referrals-count" class="font-medium text-accent">0</p>
                </div>
                <div class="flex justify-between">
                    <p class="text-gray-400">Tasks Completed</p>
                    <p id="tasks-completed" class="font-medium text-accent">0</p>
                </div>
            </div>
        </div>

        <div class="card-bg p-4 rounded-lg">
            <h3 class="text-lg font-semibold mb-4">Settings</h3>
            <div class="space-y-3">
                <button id="edit-profile-btn" class="w-full p-3 rounded-lg btn-outline-accent flex items-center justify-between">
                    <span>Edit Profile</span>
                    <i data-lucide="edit" class="w-4 h-4"></i>
                </button>
                <button id="change-password-btn" class="w-full p-3 rounded-lg btn-outline-accent flex items-center justify-between">
                    <span>Change Password</span>
                    <i data-lucide="key" class="w-4 h-4"></i>
                </button>
                <button id="notification-settings-btn" class="w-full p-3 rounded-lg btn-outline-accent flex items-center justify-between">
                    <span>Notification Settings</span>
                    <i data-lucide="bell" class="w-4 h-4"></i>
                </button>
                <button id="privacy-settings-btn" class="w-full p-3 rounded-lg btn-outline-accent flex items-center justify-between">
                    <span>Privacy & Security</span>
                    <i data-lucide="shield" class="w-4 h-4"></i>
                </button>
            </div>
        </div>

        <button id="logout-btn" class="w-full p-3 rounded-lg bg-red-600 text-white font-bold">Logout</button>

        <div class="text-center text-xs text-gray-500 mt-8">
            <p>CashReward App v1.0</p>
            <p class="mt-1">Â© 2023 CashReward. All rights reserved.</p>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="edit-profile-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-lg p-6 w-full max-w-sm">
            <h3 class="text-lg font-bold mb-4">Edit Profile</h3>
            <div class="space-y-4">
                <input id="edit-name" type="text" placeholder="Full Name" class="w-full p-3 rounded-lg input-field">
                <input id="edit-email" type="email" placeholder="Email" class="w-full p-3 rounded-lg input-field">
                <div class="flex space-x-3">
                    <button id="cancel-edit-btn" class="flex-1 p-3 rounded-lg bg-gray-700 text-white">Cancel</button>
                    <button id="save-profile-btn" class="flex-1 p-3 rounded-lg btn-accent">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="change-password-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-lg p-6 w-full max-w-sm">
            <h3 class="text-lg font-bold mb-4">Change Password</h3>
            <div class="space-y-4">
                <input id="current-password" type="password" placeholder="Current Password" class="w-full p-3 rounded-lg input-field">
                <input id="new-password" type="password" placeholder="New Password" class="w-full p-3 rounded-lg input-field">
                <input id="confirm-password" type="password" placeholder="Confirm New Password" class="w-full p-3 rounded-lg input-field">
                <div class="flex space-x-3">
                    <button id="cancel-password-btn" class="flex-1 p-3 rounded-lg bg-gray-700 text-white">Cancel</button>
                    <button id="save-password-btn" class="flex-1 p-3 rounded-lg btn-accent">Update</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Alert -->
    <div id="custom-alert" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-lg p-6 w-full max-w-sm text-center">
            <p id="alert-message" class="mb-4"></p>
            <button id="alert-ok-btn" class="btn-accent px-6 py-2 rounded-lg">OK</button>
        </div>
    </div>

    <script type="module">
        const firebaseConfig = {
            apiKey: "AIzaSyDMN3D2ghLboXbXCR3EJ53gJTuEeYR9N8Y",
            authDomain: "earm-db1ec.firebaseapp.com",
            projectId: "earm-db1ec",
            // ... other keys
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, updatePassword, reauthenticateWithCredential, EmailAuthProvider } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let userData = null;

        const loader = document.getElementById('loader');
        const profileContent = document.getElementById('profile-content');
        const profileNameEl = document.getElementById('profile-name');
        const profileEmailEl = document.getElementById('profile-email');
        const userIdEl = document.getElementById('user-id');
        const memberSinceEl = document.getElementById('member-since');
        const referralCodeEl = document.getElementById('referral-code');
        const referredByEl = document.getElementById('referred-by');
        const totalCoinsEarnedEl = document.getElementById('total-coins-earned');
        const coinsWithdrawnEl = document.getElementById('coins-withdrawn');
        const referralsCountEl = document.getElementById('referrals-count');
        const tasksCompletedEl = document.getElementById('tasks-completed');

        window.onload = () => {
            lucide.createIcons();
            setupEventListeners();
            onAuthStateChanged(auth, handleAuthStateChange);
        };

        async function handleAuthStateChange(user) {
            if (user) {
                currentUser = user;
                await fetchUserData();
                if (userData && userData.isBlocked) {
                    showAlert("Your account has been blocked.");
                    await signOut(auth);
                    return;
                }
                updateUI();
                loader.classList.add('hidden');
                profileContent.classList.remove('hidden');
            } else {
                // Redirect to login page if not authenticated
                window.location.href = 'index.html';
            }
        }

        async function fetchUserData() {
            if (!currentUser) return;
            const userRef = doc(db, "users", currentUser.uid);
            try {
                const userSnap = await getDoc(userRef);
                if (userSnap.exists()) {
                    userData = userSnap.data();
                }
            } catch (error) {
                console.error("Error fetching user data:", error);
                showAlert("Error loading user data.");
            }
        }

        function updateUI() {
            if (!userData) return;
            
            profileNameEl.textContent = userData.name || 'No Name';
            profileEmailEl.textContent = userData.email || 'No Email';
            userIdEl.textContent = currentUser.uid.substring(0, 8) + '...';
            
            // Format member since date
            if (userData.createdAt) {
                const date = userData.createdAt.toDate();
                memberSinceEl.textContent = date.toLocaleDateString();
            } else {
                memberSinceEl.textContent = 'N/A';
            }
            
            referralCodeEl.textContent = userData.referralCode || 'N/A';
            referredByEl.textContent = userData.referredBy || 'None';
            
            // Set statistics (these would need to be calculated from transaction history)
            totalCoinsEarnedEl.textContent = userData.totalEarned || userData.balance || 0;
            coinsWithdrawnEl.textContent = userData.totalWithdrawn || 0;
            
            // Count referrals
            countReferrals();
            
            // Count tasks completed
            tasksCompletedEl.textContent = userData.tasksCompleted || 0;
        }

        async function countReferrals() {
            if (!currentUser || !userData.referralCode) {
                referralsCountEl.textContent = '0';
                return;
            }
            
            const usersRef = collection(db, "users");
            const q = query(usersRef, where("referredBy", "==", userData.referralCode));
            try {
                const querySnapshot = await getDocs(q);
                referralsCountEl.textContent = querySnapshot.size.toString();
            } catch (error) {
                console.error("Error counting referrals:", error);
                referralsCountEl.textContent = '0';
            }
        }

        function setupEventListeners() {
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('edit-profile-btn').addEventListener('click', showEditProfileModal);
            document.getElementById('change-password-btn').addEventListener('click', showChangePasswordModal);
            document.getElementById('cancel-edit-btn').addEventListener('click', hideEditProfileModal);
            document.getElementById('cancel-password-btn').addEventListener('click', hideChangePasswordModal);
            document.getElementById('save-profile-btn').addEventListener('click', handleSaveProfile);
            document.getElementById('save-password-btn').addEventListener('click', handleChangePassword);
            document.getElementById('alert-ok-btn').addEventListener('click', () => {
                document.getElementById('custom-alert').classList.add('hidden');
            });
        }

        async function handleLogout() {
            try {
                await signOut(auth);
                window.location.href = 'index.html';
            } catch (error) {
                console.error("Error signing out:", error);
                showAlert("Error signing out. Please try again.");
            }
        }

        function showEditProfileModal() {
            document.getElementById('edit-profile-modal').classList.remove('hidden');
            document.getElementById('edit-name').value = userData.name || '';
            document.getElementById('edit-email').value = userData.email || '';
        }

        function hideEditProfileModal() {
            document.getElementById('edit-profile-modal').classList.add('hidden');
        }

        function showChangePasswordModal() {
            document.getElementById('change-password-modal').classList.remove('hidden');
            document.getElementById('current-password').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-password').value = '';
        }

        function hideChangePasswordModal() {
            document.getElementById('change-password-modal').classList.add('hidden');
        }

        async function handleSaveProfile() {
            const newName = document.getElementById('edit-name').value.trim();
            const newEmail = document.getElementById('edit-email').value.trim();
            
            if (!newName) {
                showAlert("Please enter your name.");
                return;
            }
            
            if (!newEmail) {
                showAlert("Please enter your email.");
                return;
            }
            
            loader.classList.remove('hidden');
            
            try {
                const userRef = doc(db, "users", currentUser.uid);
                await updateDoc(userRef, {
                    name: newName,
                    email: newEmail
                });
                
                userData.name = newName;
                userData.email = newEmail;
                updateUI();
                
                hideEditProfileModal();
                showAlert("Profile updated successfully!");
            } catch (error) {
                console.error("Error updating profile:", error);
                showAlert("Error updating profile. Please try again.");
            } finally {
                loader.classList.add('hidden');
            }
        }

        async function handleChangePassword() {
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            if (!currentPassword || !newPassword || !confirmPassword) {
                showAlert("Please fill in all password fields.");
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showAlert("New passwords do not match.");
                return;
            }
            
            if (newPassword.length < 6) {
                showAlert("New password must be at least 6 characters long.");
                return;
            }
            
            loader.classList.remove('hidden');
            
            try {
                // Reauthenticate user
                const credential = EmailAuthProvider.credential(currentUser.email, currentPassword);
                await reauthenticateWithCredential(currentUser, credential);
                
                // Update password
                await updatePassword(currentUser, newPassword);
                
                hideChangePasswordModal();
                showAlert("Password updated successfully!");
            } catch (error) {
                console.error("Error changing password:", error);
                if (error.code === 'auth/wrong-password') {
                    showAlert("Current password is incorrect.");
                } else {
                    showAlert("Error changing password. Please try again.");
                }
            } finally {
                loader.classList.add('hidden');
            }
        }

        function showAlert(message) {
            document.getElementById('alert-message').textContent = message;
            document.getElementById('custom-alert').classList.remove('hidden');
        }
    </script>
</body>
</html>